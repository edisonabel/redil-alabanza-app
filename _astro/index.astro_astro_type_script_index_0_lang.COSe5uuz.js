document.addEventListener("DOMContentLoaded",()=>{const E=document.getElementById("searchInput"),T=document.getElementById("filterVoz"),I=document.getElementById("filterCategoria"),x=document.getElementById("filterTema"),V=document.getElementById("mainTitle"),k=document.getElementById("searchControls"),g=document.getElementById("setlistPanel"),B=document.getElementById("setlistCount"),O=document.getElementById("btnCopySetlist"),M=document.getElementById("btnClearSetlist"),h=document.getElementById("btnViewGrid"),b=document.getElementById("btnViewList"),y=document.getElementById("gridCanciones"),p=document.querySelectorAll("#gridCanciones article");let C=!1;function N(){if(!y)return;C=!1,y.className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto",p.forEach(t=>t.classList.remove("modo-lista","expandido")),((t,e)=>{!t||!e||(t.classList.add("bg-neutral-800","text-white","shadow-sm"),t.classList.remove("text-neutral-400","hover:text-white"),e.classList.remove("bg-neutral-800","text-white","shadow-sm"),e.classList.add("text-neutral-400","hover:text-white"))})(h,b)}function U(){if(!y)return;C=!0,y.className="flex flex-col gap-3 max-w-4xl mx-auto",p.forEach(t=>t.classList.add("modo-lista")),((t,e)=>{!t||!e||(e.classList.add("bg-neutral-800","text-white","shadow-sm"),e.classList.remove("text-neutral-400","hover:text-white"),t.classList.remove("bg-neutral-800","text-white","shadow-sm"),t.classList.add("text-neutral-400","hover:text-white"))})(h,b)}h&&h.addEventListener("click",N),b&&b.addEventListener("click",U),p.forEach(n=>{const t=n.querySelector(".card-header");t&&t.addEventListener("click",e=>{e.target.closest(".btn-add-setlist")||C&&n.classList.toggle("expandido")})});let d=JSON.parse(localStorage.getItem("setlist")||"[]");function S(){B&&(B.textContent=d.length.toString()),g&&(d.length>0?g.classList.remove("hidden"):g.classList.add("hidden"))}document.addEventListener("click",n=>{const t=n.target.closest(".btn-add-setlist");if(t){const e=t.getAttribute("data-cancion");if(e&&!d.includes(e)){d.push(e),localStorage.setItem("setlist",JSON.stringify(d)),S();const s=t.querySelector("svg");s&&(s.innerHTML='<polyline points="20 6 9 17 4 12"></polyline>',t.classList.replace("text-blue-400","text-green-400"),t.classList.replace("bg-blue-500/10","bg-green-500/10"))}}}),O&&O.addEventListener("click",()=>{const n=btoa(encodeURIComponent(JSON.stringify(d))),t=encodeURIComponent(n),s=window.location.origin+window.location.pathname+"?setlist="+t;navigator.clipboard.writeText(s).then(()=>{alert("¡Setlist copiado y abierto en una nueva pestaña!"),window.open(s,"_blank")})}),M&&M.addEventListener("click",()=>{d=[],localStorage.removeItem("setlist"),S(),window.location.href=window.location.pathname});const P=new URLSearchParams(window.location.search).get("setlist");if(P)try{const n=decodeURIComponent(atob(P)),t=JSON.parse(n);k&&(k.style.display="none"),g&&(g.style.display="none"),V&&(V.innerHTML='Setlist de la <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400">Semana</span>'),p.forEach(e=>{const s=e.getAttribute("data-cancion")||"";if(t.includes(s)){e.style.display="block";const a=e.querySelector(".btn-add-setlist");a&&(a.style.display="none")}else e.style.display="none"})}catch(n){console.error("Error validando el link del setlist:",n),window.location.href=window.location.pathname}else{let n=function(){const m=a.slice(i,i+c);if(m.length===0){e&&(e.style.display="none");return}m.forEach(w=>w.classList.remove("cancion-oculta")),i+=c,e&&(e.style.display=i>=a.length?"none":"block")},t=function(){const m=E.value.toLowerCase().trim(),w=T.value,R=I.value,q=x.value;s.forEach(l=>l.classList.add("cancion-oculta")),i=0,a=s.filter(l=>{const H=l.getAttribute("data-titulo")||"",J=l.getAttribute("data-artista")||"",F=l.getAttribute("data-voz")||"",_=l.getAttribute("data-categoria")||"",$=l.getAttribute("data-tema")||"",j=H.includes(m)||J.includes(m),K=w==="Todas"||F.includes(w),Q=R==="Todas"||_.includes(R),W=q==="Todas"||$.includes(q);return j&&K&&Q&&W}),a.forEach(l=>l.style.display=""),n()};S();const e=document.getElementById("scroll-sentinel"),s=Array.from(p);let a=[...s],i=0;const c=15,r=new IntersectionObserver(m=>{m[0].isIntersecting&&n()},{rootMargin:"200px"});e&&r.observe(e),E&&E.addEventListener("input",t),T&&T.addEventListener("change",t),I&&I.addEventListener("change",t),x&&x.addEventListener("change",t)}const v=document.getElementById("btn-theme-toggle"),L=document.getElementById("logo-img");function A(n){if(!v)return;const t=v.querySelector("svg");n==="claro"?(document.body.classList.add("tema-claro"),L&&(L.src="/LOGO REDIL LIGHT.png"),t&&(t.innerHTML='<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>')):(document.body.classList.remove("tema-claro"),L&&(L.src="/LOGO REDIL.png"),t&&(t.innerHTML='<circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path>'))}localStorage.getItem("tema")==="claro"?A("claro"):A("oscuro"),v&&v.addEventListener("click",()=>{const t=document.body.classList.contains("tema-claro")?"oscuro":"claro";localStorage.setItem("tema",t),A(t)});let u=null,f=null;const z=window.AudioContext||window.webkitAudioContext,o=new z;function G(){if(!o)return;o.state==="suspended"&&o.resume();const n=o.createOscillator(),t=o.createGain();n.connect(t),t.connect(o.destination),n.type="sine",n.frequency.setValueAtTime(800,o.currentTime),t.gain.setValueAtTime(1,o.currentTime),t.gain.exponentialRampToValueAtTime(.001,o.currentTime+.1),n.start(o.currentTime),n.stop(o.currentTime+.1)}document.addEventListener("click",n=>{const t=n.target.closest(".badge-bpm");if(t){const e=t.getAttribute("data-bpm");if(!e)return;const s=parseInt(e.replace(/[^0-9]/g,""),10);if(!s||s<=0)return;const a=t.querySelector(".metronomo-dot");if(!a)return;if(u&&u!==a&&(u.classList.remove("beat-active"),u.style.removeProperty("--bpm-duration"),f&&clearInterval(f)),a.classList.contains("beat-active")){a.classList.remove("beat-active"),a.style.removeProperty("--bpm-duration"),f&&clearInterval(f),u=null;return}const i=60/s;a.style.setProperty("--bpm-duration",`${i}s`),a.classList.add("beat-active"),u=a,G(),f=setInterval(G,i*1e3)}});const D={C:261.63,"C#":277.18,D:293.66,Eb:311.13,E:329.63,F:349.23,"F#":369.99,G:392,"G#":415.3,A:440,Bb:466.16,B:493.88};document.addEventListener("click",n=>{const t=n.target.closest(".badge-tono");if(t){let e=t.getAttribute("data-tono");if(!e||e.trim()==="-"||e.trim()==="")return;e=e.replace(/m/g,"").trim();const s=D[e];if(s&&o){o.state==="suspended"&&o.resume();const a=o.createOscillator();a.type="triangle",a.frequency.value=s;const i=o.createOscillator();i.type="sine",i.frequency.value=s*2;const c=o.createGain();a.connect(c),i.connect(c),c.connect(o.destination);const r=o.currentTime;c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(.8,r+.02),c.gain.exponentialRampToValueAtTime(.1,r+.5),c.gain.exponentialRampToValueAtTime(.001,r+3),a.start(r),i.start(r),a.stop(r+3),i.stop(r+3)}}})});
