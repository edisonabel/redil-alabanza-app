document.addEventListener("DOMContentLoaded",()=>{const b=document.getElementById("searchInput"),y=document.getElementById("filterVoz"),h=document.getElementById("filterCategoria"),u=document.getElementById("filterTema"),L=document.getElementById("mainTitle"),T=document.getElementById("searchControls"),r=document.getElementById("setlistPanel"),E=document.getElementById("setlistCount"),x=document.getElementById("btnCopySetlist"),I=document.getElementById("btnClearSetlist"),g=document.getElementById("btnViewGrid"),f=document.getElementById("btnViewList"),p=document.getElementById("gridCanciones"),d=document.querySelectorAll("#gridCanciones article");let v=!1;function V(){if(!p)return;v=!1,p.className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto",d.forEach(e=>e.classList.remove("modo-lista","expandido")),((e,t)=>{!e||!t||(e.classList.add("bg-neutral-800","text-white","shadow-sm"),e.classList.remove("text-neutral-400","hover:text-white"),t.classList.remove("bg-neutral-800","text-white","shadow-sm"),t.classList.add("text-neutral-400","hover:text-white"))})(g,f)}function k(){if(!p)return;v=!0,p.className="flex flex-col gap-3 max-w-4xl mx-auto",d.forEach(e=>e.classList.add("modo-lista")),((e,t)=>{!e||!t||(t.classList.add("bg-neutral-800","text-white","shadow-sm"),t.classList.remove("text-neutral-400","hover:text-white"),e.classList.remove("bg-neutral-800","text-white","shadow-sm"),e.classList.add("text-neutral-400","hover:text-white"))})(g,f)}g&&g.addEventListener("click",V),f&&f.addEventListener("click",k),d.forEach(n=>{const e=n.querySelector(".card-header");e&&e.addEventListener("click",t=>{t.target.closest(".btn-add-setlist")||v&&n.classList.toggle("expandido")})});let c=JSON.parse(localStorage.getItem("setlist")||"[]");function w(){E&&(E.textContent=c.length.toString()),r&&(c.length>0?r.classList.remove("hidden"):r.classList.add("hidden"))}document.addEventListener("click",n=>{const e=n.target.closest(".btn-add-setlist");if(e){const t=e.getAttribute("data-cancion");if(t&&!c.includes(t)){c.push(t),localStorage.setItem("setlist",JSON.stringify(c)),w();const o=e.querySelector("svg");o&&(o.innerHTML='<polyline points="20 6 9 17 4 12"></polyline>',e.classList.replace("text-blue-400","text-green-400"),e.classList.replace("bg-blue-500/10","bg-green-500/10"))}}}),x&&x.addEventListener("click",()=>{const n=btoa(encodeURIComponent(JSON.stringify(c))),e=encodeURIComponent(n),o=window.location.origin+window.location.pathname+"?setlist="+e;navigator.clipboard.writeText(o).then(()=>{alert("¡Setlist copiado y abierto en una nueva pestaña!"),window.open(o,"_blank")})}),I&&I.addEventListener("click",()=>{c=[],localStorage.removeItem("setlist"),w(),window.location.href=window.location.pathname});const C=new URLSearchParams(window.location.search).get("setlist");if(C)try{const n=decodeURIComponent(atob(C)),e=JSON.parse(n);T&&(T.style.display="none"),r&&(r.style.display="none"),L&&(L.innerHTML='Setlist de la <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400">Semana</span>'),d.forEach(t=>{const o=t.getAttribute("data-cancion")||"";if(e.includes(o)){t.style.display="block";const s=t.querySelector(".btn-add-setlist");s&&(s.style.display="none")}else t.style.display="none"})}catch(n){console.error("Error validando el link del setlist:",n),window.location.href=window.location.pathname}else{let n=function(){const e=b.value.toLowerCase().trim(),t=y.value,o=h.value,s=u?u.value:"Todas";d.forEach(i=>{const N=i.getAttribute("data-titulo")||"",U=i.getAttribute("data-artista")||"",q=i.getAttribute("data-voz")||"",G=i.getAttribute("data-categoria")||"",O=i.getAttribute("data-tema")||"",R=N.includes(e)||U.includes(e),z=t==="Todas"||q.includes(t),D=o==="Todas"||G.includes(o),J=s==="Todas"||O.includes(s);R&&z&&D&&J?i.style.display="block":i.style.display="none"})};w(),b&&b.addEventListener("input",n),y&&y.addEventListener("change",n),h&&h.addEventListener("change",n),u&&u.addEventListener("change",n)}const S=document.getElementById("btn-theme-toggle");localStorage.getItem("tema")==="claro"&&document.body.classList.add("tema-claro"),S&&S.addEventListener("click",()=>{document.body.classList.toggle("tema-claro"),document.body.classList.contains("tema-claro")?localStorage.setItem("tema","claro"):localStorage.setItem("tema","oscuro")});let l=null,m=null;const B=window.AudioContext||window.webkitAudioContext,a=new B;function A(){if(!a)return;a.state==="suspended"&&a.resume();const n=a.createOscillator(),e=a.createGain();n.connect(e),e.connect(a.destination),n.type="sine",n.frequency.setValueAtTime(800,a.currentTime),e.gain.setValueAtTime(1,a.currentTime),e.gain.exponentialRampToValueAtTime(.001,a.currentTime+.1),n.start(a.currentTime),n.stop(a.currentTime+.1)}document.addEventListener("click",n=>{const e=n.target.closest(".badge-bpm");if(e){const t=e.getAttribute("data-bpm");if(!t)return;const o=parseInt(t.replace(/[^0-9]/g,""),10);if(!o||o<=0)return;const s=e.querySelector(".metronomo-dot");if(!s)return;if(l&&l!==s&&(l.classList.remove("beat-active"),l.style.removeProperty("--bpm-duration"),m&&clearInterval(m)),s.classList.contains("beat-active")){s.classList.remove("beat-active"),s.style.removeProperty("--bpm-duration"),m&&clearInterval(m),l=null;return}const i=60/o;s.style.setProperty("--bpm-duration",`${i}s`),s.classList.add("beat-active"),l=s,A(),m=setInterval(A,i*1e3)}});const P={C:261.63,"C#":277.18,D:293.66,Eb:311.13,E:329.63,F:349.23,"F#":369.99,G:392,"G#":415.3,A:440,Bb:466.16,B:493.88};document.addEventListener("click",n=>{const e=n.target.closest(".badge-tono");if(e){let t=e.getAttribute("data-tono");if(!t||t.trim()==="-"||t.trim()==="")return;t=t.replace(/m/g,"").trim();const o=P[t];if(o&&a){a.state==="suspended"&&a.resume();const s=a.createOscillator(),i=a.createGain();s.connect(i),i.connect(a.destination),s.type="sine",s.frequency.setValueAtTime(o,a.currentTime),i.gain.setValueAtTime(.001,a.currentTime),i.gain.exponentialRampToValueAtTime(1,a.currentTime+.1),i.gain.setValueAtTime(1,a.currentTime+1.5),i.gain.exponentialRampToValueAtTime(.001,a.currentTime+2.5),s.start(a.currentTime),s.stop(a.currentTime+2.5)}}})});
