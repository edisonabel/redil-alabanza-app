document.addEventListener("DOMContentLoaded",()=>{const b=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],E={Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#",Bb:"A#"},m=document.getElementById("input-chordpro"),v=document.getElementById("output-chordpro"),y=document.getElementById("btn-subir"),B=document.getElementById("btn-bajar"),I=document.getElementById("btn-reset"),L=document.getElementById("btn-copiar"),T=document.getElementById("btn-autoconvertir");let p=0,f="";function x(o){if(o.trim().length===0)return!1;const e=/^[A-G][#b]?(m|maj|min|sus|dim|aug|[0-9])*(?:\/[A-G][#b]?)?$/i,t=o.trim().split(/\s+/),n=t.filter(s=>e.test(s));return t.length>0&&n.length/t.length>=.6}function C(o){const e=o.split(`
`);let t=[],n=0;for(;n<e.length;){const s=e[n],l=n+1<e.length?e[n+1]:null;if(x(s)){const r=/([A-G][^\s]*)/g;let c;const a=[];for(;(c=r.exec(s))!==null;)a.push({acorde:c[1],index:c.index});if(l!==null&&!x(l)&&l.trim().length>0){let i=l.trimEnd();for(let d=a.length-1;d>=0;d--){const{acorde:g,index:u}=a[d];u>i.length&&(i=i.padEnd(u," ")),i=i.slice(0,u)+`[${g}]`+i.slice(u)}t.push(i),n+=2}else{let i=s;for(let d=a.length-1;d>=0;d--){const{acorde:g,index:u}=a[d];i=i.slice(0,u)+`[${g}]`+i.slice(u+g.length)}t.push(i),n++}}else t.push(s),n++}return t.join(`
`)}function w(o,e){const t=o.match(/^([A-G][#b]?)(.*)$/);if(!t)return o;let n=t[1];const s=t[2];E[n]&&(n=E[n]);const l=b.indexOf(n);if(l===-1)return o;let r=(l+e)%12;return r<0&&(r+=12),b[r]+s}function h(){if(!m||!v)return;const o=f||m.value;if(p===0){v.value=o;return}const e=/\[(.*?)\]/g;v.value=o.replace(e,(t,n)=>"["+w(n,p)+"]")}y&&y.addEventListener("click",()=>{p++,h()}),B&&B.addEventListener("click",()=>{p--,h()}),I&&I.addEventListener("click",()=>{p=0,h()}),m&&m.addEventListener("input",()=>{f="",p=0,h()}),T&&m&&T.addEventListener("click",()=>{m.value.trim()!==""&&(f=C(m.value),p=0,h())}),L&&v&&L.addEventListener("click",async o=>{try{await navigator.clipboard.writeText(v.value);const e=o.currentTarget,t=e.innerHTML;e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg> ¡Copiado!',e.classList.replace("bg-blue-600","bg-emerald-600"),e.classList.replace("hover:bg-blue-500","hover:bg-emerald-500"),setTimeout(()=>{e.innerHTML=t,e.classList.replace("bg-emerald-600","bg-blue-600"),e.classList.replace("hover:bg-emerald-500","hover:bg-blue-500")},2e3)}catch{alert("Error al copiar al portapapeles")}});function k(o){const e=o.split(`
`);let t="",n=!1;return e.forEach(s=>{if(s.trim()===""){n&&(t+='<div style="height: 0.75rem;"></div>');return}if(/^(VERSO|CORO|PUENTE|INTRO|OUTRO|FINAL|PRE-CORO|ESTR)/i.test(s.trim()))n&&(t+="</div></div>"),t+='<div class="song-section">',t+=`<div class="section-label">${s.trim()}</div>`,t+='<div class="section-content">',n=!0;else if(n||(t+='<div class="song-section">',t+='<div class="section-label"></div>',t+='<div class="section-content">',n=!0),s.includes("[")){t+='<div class="chord-line">';const r=s.split(/\[(.*?)\]/);r[0]&&(t+=`<span class="chord-pair"><span class="chord"></span><span class="lyric">${r[0]}</span></span>`);for(let c=1;c<r.length;c+=2){const a=r[c],i=r[c+1]||"";t+=`<span class="chord-pair">
                                       <span class="chord">${a}</span>
                                       <span class="lyric">${i}</span>
                                     </span>`}t+="</div>"}else t+=`<div class="lyric-line">${s}</div>`}),n&&(t+="</div></div>"),t}const A=document.getElementById("btn-imprimir");A&&A.addEventListener("click",()=>{const o=document.getElementById("print-titulo"),e=document.getElementById("print-tono"),t=document.getElementById("print-bpm"),n=o&&o.value.trim()!==""?o.value.trim():"SIN TÍTULO",s=e&&e.value.trim()!==""?"Tonalidad: "+e.value.trim():"",l=t&&t.value.trim()!==""?t.value.trim():"",r=document.getElementById("out-titulo"),c=document.getElementById("out-tono"),a=document.getElementById("out-bpm");r&&(r.textContent=n),c&&(c.textContent=s),a&&(a.textContent=l);const i=document.getElementById("output-chordpro"),d=document.getElementById("input-chordpro"),g=i&&i.value?i.value:d?d.value:"",u=document.getElementById("out-letra");u&&(u.innerHTML=k(g)),setTimeout(()=>{window.print()},100)})});
