document.addEventListener("DOMContentLoaded",()=>{const w=document.getElementById("searchInput"),L=document.getElementById("filterVoz"),x=document.getElementById("filterCategoria"),E=document.getElementById("filterTema"),A=document.getElementById("mainTitle"),S=document.getElementById("searchControls"),g=document.getElementById("setlistPanel"),V=document.getElementById("setlistCount"),k=document.getElementById("btnCopySetlist"),B=document.getElementById("btnClearSetlist"),b=document.getElementById("btnViewGrid"),h=document.getElementById("btnViewList"),y=document.getElementById("gridCanciones"),f=document.querySelectorAll("#gridCanciones article");let T=!1;function R(){if(!y)return;T=!1,y.className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto",f.forEach(t=>t.classList.remove("modo-lista","expandido")),((t,e)=>{!t||!e||(t.classList.add("bg-neutral-800","text-white","shadow-sm"),t.classList.remove("text-neutral-400","hover:text-white"),e.classList.remove("bg-neutral-800","text-white","shadow-sm"),e.classList.add("text-neutral-400","hover:text-white"))})(b,h),document.body.offsetHeight}function U(){if(!y)return;T=!0,y.className="flex flex-col gap-3 max-w-4xl mx-auto",f.forEach(t=>t.classList.add("modo-lista")),((t,e)=>{!t||!e||(e.classList.add("bg-neutral-800","text-white","shadow-sm"),e.classList.remove("text-neutral-400","hover:text-white"),t.classList.remove("bg-neutral-800","text-white","shadow-sm"),t.classList.add("text-neutral-400","hover:text-white"))})(b,h),document.body.offsetHeight}b&&b.addEventListener("click",R),h&&h.addEventListener("click",U),f.forEach(o=>{const t=o.querySelector(".card-header");t&&t.addEventListener("click",e=>{e.target.closest(".btn-add-setlist")||T&&o.classList.toggle("expandido")})});let d=JSON.parse(localStorage.getItem("setlist")||"[]");function C(){V&&(V.textContent=d.length.toString()),g&&(d.length>0?g.classList.remove("hidden"):g.classList.add("hidden"))}document.addEventListener("click",o=>{const t=o.target.closest(".btn-add-setlist"),e=o.target.closest(".btn-editor");if(e){o.preventDefault();const s=e,n=s.getAttribute("data-chordpro")||"",i=s.getAttribute("data-titulo")||"",c=s.getAttribute("data-bpm")||"",r=s.getAttribute("data-key")||"";if(n.trim()){const I={chordpro:n,title:i,bpm:c,key:r};sessionStorage.setItem("chordpro_bridge",JSON.stringify(I)),window.location.href="/herramientas/chordpro"}return}if(t){const s=t.getAttribute("data-cancion");if(s&&!d.includes(s)){d.push(s),localStorage.setItem("setlist",JSON.stringify(d)),C();const n=t.querySelector("svg");n&&(n.innerHTML='<polyline points="20 6 9 17 4 12"></polyline>',t.classList.replace("text-blue-400","text-green-400"),t.classList.replace("bg-blue-500/10","bg-green-500/10"))}}}),k&&k.addEventListener("click",()=>{const o=btoa(encodeURIComponent(JSON.stringify(d))),t=encodeURIComponent(o),s=window.location.origin+window.location.pathname+"?setlist="+t;navigator.clipboard.writeText(s).then(()=>{alert("¡Setlist copiado y abierto en una nueva pestaña!"),window.open(s,"_blank")})}),B&&B.addEventListener("click",()=>{d=[],localStorage.removeItem("setlist"),C(),window.location.href=window.location.pathname});const P=new URLSearchParams(window.location.search).get("setlist");if(P)try{const o=decodeURIComponent(atob(P)),t=JSON.parse(o);S&&(S.style.display="none"),g&&(g.style.display="none"),A&&(A.innerHTML='Setlist de la <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400">Semana</span>'),f.forEach(e=>{const s=e.getAttribute("data-cancion")||"";if(t.includes(s)){e.style.display="block";const n=e.querySelector(".btn-add-setlist");n&&(n.style.display="none")}else e.style.display="none"})}catch(o){console.error("Error validando el link del setlist:",o),window.location.href=window.location.pathname}else{let o=function(){if(r)return;r=!0;const u=n.slice(i,i+c);if(u.length===0){e&&(e.style.display="none"),r=!1;return}u.forEach(v=>v.classList.remove("cancion-oculta")),i+=c,e&&(e.style.display=i>=n.length?"none":"block"),setTimeout(()=>{r=!1},150)},t=function(){const u=w.value.toLowerCase().trim(),v=L.value,N=x.value,q=E.value;s.forEach(l=>l.classList.add("cancion-oculta")),i=0,n=s.filter(l=>{const D=l.getAttribute("data-titulo")||"",J=l.getAttribute("data-artista")||"",M=l.getAttribute("data-voz")||"",H=l.getAttribute("data-categoria")||"",F=l.getAttribute("data-tema")||"",_=D.includes(u)||J.includes(u),$=v==="Todas"||M.includes(v),j=N==="Todas"||H.includes(N),K=q==="Todas"||F.includes(q);return _&&$&&j&&K}),n.forEach(l=>l.style.display=""),o()};C();const e=document.getElementById("scroll-sentinel"),s=Array.from(f);let n=[...s],i=0;const c=15;let r=!1;const I=new IntersectionObserver(u=>{u[0].isIntersecting&&o()},{root:null,rootMargin:"0px 0px 400px 0px",threshold:0});e&&I.observe(e),w&&w.addEventListener("input",t),L&&L.addEventListener("change",t),x&&x.addEventListener("change",t),E&&E.addEventListener("change",t)}let m=null,p=null;const G=window.AudioContext||window.webkitAudioContext,a=new G;function O(){if(!a)return;a.state==="suspended"&&a.resume();const o=a.createOscillator(),t=a.createGain();o.connect(t),t.connect(a.destination),o.type="sine",o.frequency.setValueAtTime(800,a.currentTime),t.gain.setValueAtTime(1,a.currentTime),t.gain.exponentialRampToValueAtTime(.001,a.currentTime+.1),o.start(a.currentTime),o.stop(a.currentTime+.1)}document.addEventListener("click",o=>{const t=o.target.closest(".badge-bpm");if(t){const e=t.getAttribute("data-bpm");if(!e)return;const s=parseInt(e.replace(/[^0-9]/g,""),10);if(!s||s<=0)return;const n=t.querySelector(".metronomo-dot");if(!n)return;if(m&&m!==n&&(m.classList.remove("beat-active"),m.style.removeProperty("--bpm-duration"),p&&clearInterval(p)),n.classList.contains("beat-active")){n.classList.remove("beat-active"),n.style.removeProperty("--bpm-duration"),p&&clearInterval(p),m=null;return}const i=60/s;n.style.setProperty("--bpm-duration",`${i}s`),n.classList.add("beat-active"),m=n,O(),p=setInterval(O,i*1e3)}});const z={C:261.63,"C#":277.18,D:293.66,Eb:311.13,E:329.63,F:349.23,"F#":369.99,G:392,"G#":415.3,A:440,Bb:466.16,B:493.88};document.addEventListener("click",o=>{const t=o.target.closest(".badge-tono");if(t){let e=t.getAttribute("data-tono");if(!e||e.trim()==="-"||e.trim()==="")return;e=e.replace(/m/g,"").trim();const s=z[e];if(s&&a){a.state==="suspended"&&a.resume();const n=a.createOscillator();n.type="triangle",n.frequency.value=s;const i=a.createOscillator();i.type="sine",i.frequency.value=s*2;const c=a.createGain();n.connect(c),i.connect(c),c.connect(a.destination);const r=a.currentTime;c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(.8,r+.02),c.gain.exponentialRampToValueAtTime(.1,r+.5),c.gain.exponentialRampToValueAtTime(.001,r+3),n.start(r),i.start(r),n.stop(r+3),i.stop(r+3)}}})});
