document.addEventListener("DOMContentLoaded",()=>{const L=document.getElementById("searchInput"),w=document.getElementById("filterVoz"),T=document.getElementById("filterCategoria"),E=document.getElementById("filterTema"),S=document.getElementById("mainTitle"),A=document.getElementById("searchControls"),m=document.getElementById("setlistPanel"),V=document.getElementById("setlistCount"),k=document.getElementById("btnCopySetlist"),B=document.getElementById("btnClearSetlist"),p=document.getElementById("btnViewGrid"),f=document.getElementById("btnViewList"),h=document.getElementById("gridCanciones"),u=document.querySelectorAll("#gridCanciones article");let I=!1;function q(){if(!h)return;I=!1,h.className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto",u.forEach(t=>t.classList.remove("modo-lista","expandido")),((t,e)=>{!t||!e||(t.classList.add("bg-neutral-800","text-white","shadow-sm"),t.classList.remove("text-neutral-400","hover:text-white"),e.classList.remove("bg-neutral-800","text-white","shadow-sm"),e.classList.add("text-neutral-400","hover:text-white"))})(p,f)}function N(){if(!h)return;I=!0,h.className="flex flex-col gap-3 max-w-4xl mx-auto",u.forEach(t=>t.classList.add("modo-lista")),((t,e)=>{!t||!e||(e.classList.add("bg-neutral-800","text-white","shadow-sm"),e.classList.remove("text-neutral-400","hover:text-white"),t.classList.remove("bg-neutral-800","text-white","shadow-sm"),t.classList.add("text-neutral-400","hover:text-white"))})(p,f)}p&&p.addEventListener("click",q),f&&f.addEventListener("click",N),u.forEach(n=>{const t=n.querySelector(".card-header");t&&t.addEventListener("click",e=>{e.target.closest(".btn-add-setlist")||I&&n.classList.toggle("expandido")})});let r=JSON.parse(localStorage.getItem("setlist")||"[]");function x(){V&&(V.textContent=r.length.toString()),m&&(r.length>0?m.classList.remove("hidden"):m.classList.add("hidden"))}document.addEventListener("click",n=>{const t=n.target.closest(".btn-add-setlist");if(t){const e=t.getAttribute("data-cancion");if(e&&!r.includes(e)){r.push(e),localStorage.setItem("setlist",JSON.stringify(r)),x();const o=t.querySelector("svg");o&&(o.innerHTML='<polyline points="20 6 9 17 4 12"></polyline>',t.classList.replace("text-blue-400","text-green-400"),t.classList.replace("bg-blue-500/10","bg-green-500/10"))}}}),k&&k.addEventListener("click",()=>{const n=btoa(encodeURIComponent(JSON.stringify(r))),t=encodeURIComponent(n),o=window.location.origin+window.location.pathname+"?setlist="+t;navigator.clipboard.writeText(o).then(()=>{alert("¡Setlist copiado y abierto en una nueva pestaña!"),window.open(o,"_blank")})}),B&&B.addEventListener("click",()=>{r=[],localStorage.removeItem("setlist"),x(),window.location.href=window.location.pathname});const M=new URLSearchParams(window.location.search).get("setlist");if(M)try{const n=decodeURIComponent(atob(M)),t=JSON.parse(n);A&&(A.style.display="none"),m&&(m.style.display="none"),S&&(S.innerHTML='Setlist de la <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400">Semana</span>'),u.forEach(e=>{const o=e.getAttribute("data-cancion")||"";if(t.includes(o)){e.style.display="block";const s=e.querySelector(".btn-add-setlist");s&&(s.style.display="none")}else e.style.display="none"})}catch(n){console.error("Error validando el link del setlist:",n),window.location.href=window.location.pathname}else{let n=function(){const l=s.slice(i,i+G);if(l.length===0){e&&(e.style.display="none");return}l.forEach(v=>v.classList.remove("cancion-oculta")),i+=G,e&&(e.style.display=i>=s.length?"none":"block")},t=function(){const l=L.value.toLowerCase().trim(),v=w.value,P=T.value,R=E.value;o.forEach(c=>c.classList.add("cancion-oculta")),i=0,s=o.filter(c=>{const H=c.getAttribute("data-titulo")||"",J=c.getAttribute("data-artista")||"",F=c.getAttribute("data-voz")||"",_=c.getAttribute("data-categoria")||"",$=c.getAttribute("data-tema")||"",j=H.includes(l)||J.includes(l),K=v==="Todas"||F.includes(v),Q=P==="Todas"||_.includes(P),W=R==="Todas"||$.includes(R);return j&&K&&Q&&W}),s.forEach(c=>c.style.display=""),n()};x();const e=document.getElementById("scroll-sentinel"),o=Array.from(u);let s=[...o],i=0;const G=15,D=new IntersectionObserver(l=>{l[0].isIntersecting&&n()},{rootMargin:"200px"});e&&D.observe(e),L&&L.addEventListener("input",t),w&&w.addEventListener("change",t),T&&T.addEventListener("change",t),E&&E.addEventListener("change",t)}const b=document.getElementById("btn-theme-toggle"),y=document.getElementById("logo-img");function C(n){if(!b)return;const t=b.querySelector("svg");n==="claro"?(document.body.classList.add("tema-claro"),y&&(y.src="/LOGO REDIL LIGHT.png"),t&&(t.innerHTML='<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>')):(document.body.classList.remove("tema-claro"),y&&(y.src="/LOGO REDIL.png"),t&&(t.innerHTML='<circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path>'))}localStorage.getItem("tema")==="claro"?C("claro"):C("oscuro"),b&&b.addEventListener("click",()=>{const t=document.body.classList.contains("tema-claro")?"oscuro":"claro";localStorage.setItem("tema",t),C(t)});let d=null,g=null;const U=window.AudioContext||window.webkitAudioContext,a=new U;function O(){if(!a)return;a.state==="suspended"&&a.resume();const n=a.createOscillator(),t=a.createGain();n.connect(t),t.connect(a.destination),n.type="sine",n.frequency.setValueAtTime(800,a.currentTime),t.gain.setValueAtTime(1,a.currentTime),t.gain.exponentialRampToValueAtTime(.001,a.currentTime+.1),n.start(a.currentTime),n.stop(a.currentTime+.1)}document.addEventListener("click",n=>{const t=n.target.closest(".badge-bpm");if(t){const e=t.getAttribute("data-bpm");if(!e)return;const o=parseInt(e.replace(/[^0-9]/g,""),10);if(!o||o<=0)return;const s=t.querySelector(".metronomo-dot");if(!s)return;if(d&&d!==s&&(d.classList.remove("beat-active"),d.style.removeProperty("--bpm-duration"),g&&clearInterval(g)),s.classList.contains("beat-active")){s.classList.remove("beat-active"),s.style.removeProperty("--bpm-duration"),g&&clearInterval(g),d=null;return}const i=60/o;s.style.setProperty("--bpm-duration",`${i}s`),s.classList.add("beat-active"),d=s,O(),g=setInterval(O,i*1e3)}});const z={C:261.63,"C#":277.18,D:293.66,Eb:311.13,E:329.63,F:349.23,"F#":369.99,G:392,"G#":415.3,A:440,Bb:466.16,B:493.88};document.addEventListener("click",n=>{const t=n.target.closest(".badge-tono");if(t){let e=t.getAttribute("data-tono");if(!e||e.trim()==="-"||e.trim()==="")return;e=e.replace(/m/g,"").trim();const o=z[e];if(o&&a){a.state==="suspended"&&a.resume();const s=a.createOscillator(),i=a.createGain();s.connect(i),i.connect(a.destination),s.type="sine",s.frequency.setValueAtTime(o,a.currentTime),i.gain.setValueAtTime(.001,a.currentTime),i.gain.exponentialRampToValueAtTime(1,a.currentTime+.1),i.gain.setValueAtTime(1,a.currentTime+1.5),i.gain.exponentialRampToValueAtTime(.001,a.currentTime+2.5),s.start(a.currentTime),s.stop(a.currentTime+2.5)}}})});
