document.addEventListener("DOMContentLoaded",()=>{const w=document.getElementById("searchInput"),L=document.getElementById("filterVoz"),E=document.getElementById("filterCategoria"),x=document.getElementById("filterTema"),I=document.getElementById("mainTitle"),S=document.getElementById("searchControls"),g=document.getElementById("setlistPanel"),A=document.getElementById("setlistCount"),V=document.getElementById("btnCopySetlist"),k=document.getElementById("btnClearSetlist"),b=document.getElementById("btnViewGrid"),y=document.getElementById("btnViewList"),v=document.getElementById("gridCanciones"),f=document.querySelectorAll("#gridCanciones article");let T=!1;function N(){if(!v)return;T=!1,v.className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto",f.forEach(t=>t.classList.remove("modo-lista","expandido")),((t,e)=>{!t||!e||(t.classList.add("bg-neutral-800","text-white","shadow-sm"),t.classList.remove("text-neutral-400","hover:text-white"),e.classList.remove("bg-neutral-800","text-white","shadow-sm"),e.classList.add("text-neutral-400","hover:text-white"))})(b,y),document.body.offsetHeight}function R(){if(!v)return;T=!0,v.className="flex flex-col gap-3 max-w-4xl mx-auto",f.forEach(t=>t.classList.add("modo-lista")),((t,e)=>{!t||!e||(e.classList.add("bg-neutral-800","text-white","shadow-sm"),e.classList.remove("text-neutral-400","hover:text-white"),t.classList.remove("bg-neutral-800","text-white","shadow-sm"),t.classList.add("text-neutral-400","hover:text-white"))})(b,y),document.body.offsetHeight}b&&b.addEventListener("click",N),y&&y.addEventListener("click",R),f.forEach(n=>{const t=n.querySelector(".card-header");t&&t.addEventListener("click",e=>{e.target.closest(".btn-add-setlist")||T&&n.classList.toggle("expandido")})});let d=JSON.parse(localStorage.getItem("setlist")||"[]");function C(){A&&(A.textContent=d.length.toString()),g&&(d.length>0?g.classList.remove("hidden"):g.classList.add("hidden"))}document.addEventListener("click",n=>{const t=n.target.closest(".btn-add-setlist");if(t){const e=t.getAttribute("data-cancion");if(e&&!d.includes(e)){d.push(e),localStorage.setItem("setlist",JSON.stringify(d)),C();const a=t.querySelector("svg");a&&(a.innerHTML='<polyline points="20 6 9 17 4 12"></polyline>',t.classList.replace("text-blue-400","text-green-400"),t.classList.replace("bg-blue-500/10","bg-green-500/10"))}}}),V&&V.addEventListener("click",()=>{const n=btoa(encodeURIComponent(JSON.stringify(d))),t=encodeURIComponent(n),a=window.location.origin+window.location.pathname+"?setlist="+t;navigator.clipboard.writeText(a).then(()=>{alert("¡Setlist copiado y abierto en una nueva pestaña!"),window.open(a,"_blank")})}),k&&k.addEventListener("click",()=>{d=[],localStorage.removeItem("setlist"),C(),window.location.href=window.location.pathname});const B=new URLSearchParams(window.location.search).get("setlist");if(B)try{const n=decodeURIComponent(atob(B)),t=JSON.parse(n);S&&(S.style.display="none"),g&&(g.style.display="none"),I&&(I.innerHTML='Setlist de la <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400">Semana</span>'),f.forEach(e=>{const a=e.getAttribute("data-cancion")||"";if(t.includes(a)){e.style.display="block";const s=e.querySelector(".btn-add-setlist");s&&(s.style.display="none")}else e.style.display="none"})}catch(n){console.error("Error validando el link del setlist:",n),window.location.href=window.location.pathname}else{let n=function(){const u=s.slice(i,i+c);if(u.length===0){e&&(e.style.display="none");return}u.forEach(h=>h.classList.remove("cancion-oculta")),i+=c,e&&(e.style.display=i>=s.length?"none":"block")},t=function(){const u=w.value.toLowerCase().trim(),h=L.value,O=E.value,q=x.value;a.forEach(l=>l.classList.add("cancion-oculta")),i=0,s=a.filter(l=>{const z=l.getAttribute("data-titulo")||"",M=l.getAttribute("data-artista")||"",D=l.getAttribute("data-voz")||"",H=l.getAttribute("data-categoria")||"",J=l.getAttribute("data-tema")||"",F=z.includes(u)||M.includes(u),_=h==="Todas"||D.includes(h),$=O==="Todas"||H.includes(O),j=q==="Todas"||J.includes(q);return F&&_&&$&&j}),s.forEach(l=>l.style.display=""),n()};C();const e=document.getElementById("scroll-sentinel"),a=Array.from(f);let s=[...a],i=0;const c=15,r=new IntersectionObserver(u=>{u[0].isIntersecting&&n()},{rootMargin:"200px"});e&&r.observe(e),w&&w.addEventListener("input",t),L&&L.addEventListener("change",t),E&&E.addEventListener("change",t),x&&x.addEventListener("change",t)}let m=null,p=null;const U=window.AudioContext||window.webkitAudioContext,o=new U;function P(){if(!o)return;o.state==="suspended"&&o.resume();const n=o.createOscillator(),t=o.createGain();n.connect(t),t.connect(o.destination),n.type="sine",n.frequency.setValueAtTime(800,o.currentTime),t.gain.setValueAtTime(1,o.currentTime),t.gain.exponentialRampToValueAtTime(.001,o.currentTime+.1),n.start(o.currentTime),n.stop(o.currentTime+.1)}document.addEventListener("click",n=>{const t=n.target.closest(".badge-bpm");if(t){const e=t.getAttribute("data-bpm");if(!e)return;const a=parseInt(e.replace(/[^0-9]/g,""),10);if(!a||a<=0)return;const s=t.querySelector(".metronomo-dot");if(!s)return;if(m&&m!==s&&(m.classList.remove("beat-active"),m.style.removeProperty("--bpm-duration"),p&&clearInterval(p)),s.classList.contains("beat-active")){s.classList.remove("beat-active"),s.style.removeProperty("--bpm-duration"),p&&clearInterval(p),m=null;return}const i=60/a;s.style.setProperty("--bpm-duration",`${i}s`),s.classList.add("beat-active"),m=s,P(),p=setInterval(P,i*1e3)}});const G={C:261.63,"C#":277.18,D:293.66,Eb:311.13,E:329.63,F:349.23,"F#":369.99,G:392,"G#":415.3,A:440,Bb:466.16,B:493.88};document.addEventListener("click",n=>{const t=n.target.closest(".badge-tono");if(t){let e=t.getAttribute("data-tono");if(!e||e.trim()==="-"||e.trim()==="")return;e=e.replace(/m/g,"").trim();const a=G[e];if(a&&o){o.state==="suspended"&&o.resume();const s=o.createOscillator();s.type="triangle",s.frequency.value=a;const i=o.createOscillator();i.type="sine",i.frequency.value=a*2;const c=o.createGain();s.connect(c),i.connect(c),c.connect(o.destination);const r=o.currentTime;c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(.8,r+.02),c.gain.exponentialRampToValueAtTime(.1,r+.5),c.gain.exponentialRampToValueAtTime(.001,r+3),s.start(r),i.start(r),s.stop(r+3),i.stop(r+3)}}})});
