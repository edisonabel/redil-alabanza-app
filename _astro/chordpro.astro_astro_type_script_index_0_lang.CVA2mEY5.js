document.addEventListener("DOMContentLoaded",()=>{const G=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],j={Db:"C#",Eb:"D#",Gb:"F#",Ab:"G#",Bb:"A#"},f=document.getElementById("input-chordpro"),k=document.getElementById("output-chordpro"),N=document.getElementById("btn-subir"),D=document.getElementById("btn-bajar"),U=document.getElementById("btn-reset"),H=document.getElementById("btn-copiar"),V=document.getElementById("btn-autoconvertir");let v=0,M="";function q(t){if(t.trim().length===0)return!1;const e=/^[A-G][#b]?(m|maj|min|sus|dim|aug|[0-9])*(?:\/[A-G][#b]?)?$/i,n=t.trim().split(/\s+/),i=n.filter(l=>e.test(l));return n.length>0&&i.length/n.length>=.6}function J(t){const e=t.split(`
`);let n=[],i=0;for(;i<e.length;){const l=e[i],h=i+1<e.length?e[i+1]:null;if(q(l)){const r=/([A-G][^\s]*)/g;let g;const o=[];for(;(g=r.exec(l))!==null;)o.push({acorde:g[1],index:g.index});if(h!==null&&!q(h)&&h.trim().length>0){let s=h.trimEnd();for(let m=o.length-1;m>=0;m--){const{acorde:u,index:c}=o[m];c>s.length&&(s=s.padEnd(c," ")),s=s.slice(0,c)+`[${u}]`+s.slice(c)}n.push(s),i+=2}else{let s=l;for(let m=o.length-1;m>=0;m--){const{acorde:u,index:c}=o[m];s=s.slice(0,c)+`[${u}]`+s.slice(c+u.length)}n.push(s),i++}}else n.push(l),i++}return n.join(`
`)}function K(t,e){const n=t.match(/^([A-G][#b]?)(.*)$/);if(!n)return t;let i=n[1];const l=n[2];j[i]&&(i=j[i]);const h=G.indexOf(i);if(h===-1)return t;let r=(h+e)%12;return r<0&&(r+=12),G[r]+l}function L(){if(!f||!k)return;const t=M||f.value;if(v===0){k.value=t;return}const e=/\[(.*?)\]/g;k.value=t.replace(e,(n,i)=>"["+K(i,v)+"]")}N&&N.addEventListener("click",()=>{v++,L()}),D&&D.addEventListener("click",()=>{v--,L()}),U&&U.addEventListener("click",()=>{v=0,L()}),f&&f.addEventListener("input",()=>{M="",v=0,L()}),V&&f&&V.addEventListener("click",()=>{f.value.trim()!==""&&(M=J(f.value),v=0,L())}),H&&k&&H.addEventListener("click",async t=>{try{await navigator.clipboard.writeText(k.value);const e=t.currentTarget,n=e.innerHTML;e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg> ¡Copiado!',e.classList.replace("bg-blue-600","bg-emerald-600"),e.classList.replace("hover:bg-blue-500","hover:bg-emerald-500"),setTimeout(()=>{e.innerHTML=n,e.classList.replace("bg-emerald-600","bg-blue-600"),e.classList.replace("hover:bg-emerald-500","hover:bg-blue-500")},2e3)}catch{alert("Error al copiar al portapapeles")}}),document.getElementById("btn-imprimir")?.addEventListener("click",()=>{const t=document.getElementById("print-titulo"),e=document.getElementById("print-artista"),n=document.getElementById("print-tono"),i=document.getElementById("print-bpm"),l=t?.value.trim()||"SIN TÍTULO",h=e?.value.trim()||"",r=n?.value.trim()||"",g=i?.value.trim()||"",o=document.getElementById("output-chordpro")?.value,s=document.getElementById("input-chordpro")?.value;let m=o&&o.trim()!==""?o:s||"";!m.includes("[")&&typeof window.autoConvertirAChordPro=="function"&&(m=window.autoConvertirAChordPro(m));const u=m.split(`
`),c=u.length;let R="16px",S="15mm 20mm";c>35&&(R="14px",S="12mm 15mm"),c>55&&(R="11.5px",S="10mm 12mm"),c>75&&(R="9.5px",S="8mm 10mm");let a="",x=!1;u.forEach(I=>{if(I.trim()===""){x&&(a+='<div class="spacer"></div>');return}const Y=I.replace(/\[.*?\]/g,"").trim(),te=/^(VERSO\s*\d*|CORO\s*\d*|PUENTE\s*\d*|INTRO\s*\d*|OUTRO|FINAL|PRE-CORO|PRECORO|ESTR|INSTRUMENTAL|TAG)[\s\:\-]*(.*)$/i,F=Y.match(te);let b=I;if(F){x&&(a+="</div></div>");const w=F[1].toUpperCase(),E=F[2];a+=`<div class="song-section"><div class="section-label">${w}</div><div class="section-content">`,x=!0;let A="",$=!1,_=0,ne=Y.length-E.length;for(let T=0;T<I.length;T++){let p=I[T];p==="["&&($=!0),$?(A+=p,p==="]"&&($=!1)):_<ne?_++:A+=p}if(b=A.trim(),b==="")return;if(/^(\s*\[.*?\]\s*)+$/.test(b)){a+='<div class="chord-line">';const T=b.split(/\[(.*?)\]/);for(let p=1;p<T.length;p+=2)a+=`<div class="chord-pair"><div class="chord">${T[p]}</div><div class="lyric"> </div></div>`;a+="</div>";return}}else x||(a+='<div class="song-section"><div class="section-label"></div><div class="section-content">',x=!0);if(b.includes("[")){a+='<div class="chord-line">';const w=b.split(/\[(.*?)\]/);w[0]&&(a+=`<div class="chord-pair"><div class="chord"></div><div class="lyric">${w[0]}</div></div>`);for(let E=1;E<w.length;E+=2){const A=w[E],$=w[E+1]||"";a+=`<div class="chord-pair"><div class="chord">${A}</div><div class="lyric">${$}</div></div>`}a+="</div>"}else a+=`<div class="lyric-line">${b}</div>`}),x&&(a+="</div></div>");const y=window.open("","_blank");if(!y){alert("Por favor, permite las ventanas emergentes (pop-ups) para imprimir.");return}y.document.write(`
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>${l} - Acordes</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,500;0,700;0,800;1,500&display=swap" rel="stylesheet">
    <style>
      html { font-size: ${R}; }
      @page { margin: 0; size: letter; }
      body { font-family: 'Montserrat', Arial, sans-serif; color: black; background: white; margin: 0; padding: ${S}; box-sizing: border-box; }
      
      header { border-bottom: 0.2rem solid black; display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; padding-bottom: 0.5rem; }
      .header-left h1 { font-weight: 800; font-size: 2.2rem; text-transform: uppercase; margin: 0; letter-spacing: -0.02rem; }
      .header-left h2 { font-weight: 500; font-style: italic; color: #444; margin: 0.3rem 0 0 0; }
      .header-right { text-align: right; font-weight: 800; font-size: 1rem; }
      .header-right div { margin-bottom: 0.2rem; }
      
      .song-section { display: flex; width: 100%; page-break-inside: avoid; margin-bottom: 1.5rem; }
      .section-label { font-weight: 800; font-size: 0.95rem; width: 8.5rem; flex-shrink: 0; padding-right: 1rem; }
      .section-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
      
      .chord-line { display: flex; flex-wrap: wrap; align-items: flex-end; margin-bottom: 0.3rem; }
      .chord-pair { display: inline-flex; flex-direction: column; justify-content: flex-end; margin-right: 0.15rem; }
      
      .chord { font-weight: 800; font-size: 0.9rem; min-height: 1rem; margin-bottom: 0.1rem; color: #000; }
      .lyric { font-weight: 500; font-size: 1.1rem; white-space: pre; color: #111; }
      .lyric-line { font-weight: 500; font-size: 1.1rem; margin-bottom: 0.3rem; white-space: pre-wrap; color: #111; }
      .spacer { height: 1rem; }
    </style>
  </head>
  <body>
    <header>
      <div class="header-left">
        <h1>${l}</h1>
        ${h?`<h2>${h}</h2>`:""}
      </div>
      <div class="header-right">
        ${r?`<div>Tonalidad de ${r}</div>`:""}
        ${g?`<div>${g}</div>`:""}
      </div>
    </header>
    <main>${a}</main>
  </body>
</html>
            `),y.document.close(),y.focus(),setTimeout(()=>{y.print(),y.close()},1200)});let d=null,P=null,z=!1;const B=document.getElementById("btn-metronomo"),Q=document.getElementById("print-bpm");function W(){d||(d=new(window.AudioContext||window.webkitAudioContext));const t=d.createOscillator(),e=d.createGain();t.connect(e),e.connect(d.destination),t.frequency.value=800,t.type="sine",e.gain.setValueAtTime(1,d.currentTime),e.gain.exponentialRampToValueAtTime(.001,d.currentTime+.1),t.start(d.currentTime),t.stop(d.currentTime+.1)}B?.addEventListener("click",()=>{if(z)P&&clearInterval(P),B.classList.replace("bg-green-600","bg-neutral-700"),B.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>',z=!1;else{const e=Q.value.match(/\b([3-9]\d|[1-2]\d{2})\b/),i=6e4/(e?parseInt(e[0]):120);d||(d=new(window.AudioContext||window.webkitAudioContext)),d.state==="suspended"&&d.resume(),W(),P=setInterval(W,i),B.classList.replace("bg-neutral-700","bg-green-600"),B.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>',z=!0}});let O=null;const C=document.getElementById("stage-mode-container"),X=document.getElementById("btn-cerrar-atril");async function Z(){try{"wakeLock"in navigator&&(O=await navigator.wakeLock.request("screen"))}catch(t){console.log("WakeLock no soportado",t)}}function ee(){O!==null&&(O.release(),O=null)}document.getElementById("btn-atril")?.addEventListener("click",async()=>{const t=document.getElementById("print-titulo")?.value.trim()||"SIN TÍTULO",e=document.getElementById("stage-titulo");e&&(e.textContent=t);const n=document.getElementById("output-chordpro")?.value,i=document.getElementById("input-chordpro")?.value;let l=n&&n.trim()!==""?n:i||"";!l.includes("[")&&typeof window.autoConvertirAChordPro=="function"&&(l=window.autoConvertirAChordPro(l));const h=l.split(`
`);let r="";h.forEach(o=>{if(o.trim()===""){r+='<div class="h-6"></div>';return}const s=o.replace(/\[.*?\]/g,"").trim();if(/^(VERSO|CORO|PUENTE|INTRO|OUTRO|FINAL|PRE-CORO|ESTR|TAG)/i.test(s))r+=`<div class="text-blue-400 font-bold mt-8 mb-2 text-lg sm:text-xl uppercase tracking-wider">${o.trim()}</div>`;else if(o.includes("[")){r+='<div class="flex flex-wrap items-end mb-2">';const u=o.split(/\[(.*?)\]/);u[0]&&(r+=`<div class="inline-flex flex-col"><div class="text-yellow-400 font-bold text-lg sm:text-xl h-6"></div><div class="text-white whitespace-pre">${u[0]}</div></div>`);for(let c=1;c<u.length;c+=2)r+=`<div class="inline-flex flex-col mr-1.5"><div class="text-yellow-400 font-bold text-lg sm:text-xl h-6 -mb-1">${u[c]}</div><div class="text-white whitespace-pre">${u[c+1]||""}</div></div>`;r+="</div>"}else r+=`<div class="text-white mb-2">${o}</div>`});const g=document.getElementById("stage-letra");g&&(g.innerHTML=r),C?.classList.remove("hidden"),document.body.style.overflow="hidden",await Z(),C&&C.requestFullscreen&&C.requestFullscreen().catch(o=>console.log("Fullscreen error:",o))}),X?.addEventListener("click",()=>{C?.classList.add("hidden"),document.body.style.overflow="",ee(),document.fullscreenElement&&document.exitFullscreen().catch(t=>console.log(t))})});
