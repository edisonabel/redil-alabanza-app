document.addEventListener("DOMContentLoaded",()=>{const b=document.getElementById("searchInput"),h=document.getElementById("filterVoz"),y=document.getElementById("filterCategoria"),m=document.getElementById("filterTema"),L=document.getElementById("mainTitle"),x=document.getElementById("searchControls"),c=document.getElementById("setlistPanel"),E=document.getElementById("setlistCount"),C=document.getElementById("btnCopySetlist"),I=document.getElementById("btnClearSetlist"),g=document.getElementById("btnViewGrid"),f=document.getElementById("btnViewList"),p=document.getElementById("gridCanciones"),d=document.querySelectorAll("#gridCanciones article");let v=!1;function A(){if(!p)return;v=!1,p.className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto",d.forEach(t=>t.classList.remove("modo-lista","expandido")),((t,n)=>{!t||!n||(t.classList.add("bg-neutral-800","text-white","shadow-sm"),t.classList.remove("text-neutral-400","hover:text-white"),n.classList.remove("bg-neutral-800","text-white","shadow-sm"),n.classList.add("text-neutral-400","hover:text-white"))})(g,f)}function k(){if(!p)return;v=!0,p.className="flex flex-col gap-3 max-w-4xl mx-auto",d.forEach(t=>t.classList.add("modo-lista")),((t,n)=>{!t||!n||(n.classList.add("bg-neutral-800","text-white","shadow-sm"),n.classList.remove("text-neutral-400","hover:text-white"),t.classList.remove("bg-neutral-800","text-white","shadow-sm"),t.classList.add("text-neutral-400","hover:text-white"))})(g,f)}g&&g.addEventListener("click",A),f&&f.addEventListener("click",k),d.forEach(e=>{const t=e.querySelector(".card-header");t&&t.addEventListener("click",n=>{n.target.closest(".btn-add-setlist")||v&&e.classList.toggle("expandido")})});let l=JSON.parse(localStorage.getItem("setlist")||"[]");function w(){E&&(E.textContent=l.length.toString()),c&&(l.length>0?c.classList.remove("hidden"):c.classList.add("hidden"))}document.addEventListener("click",e=>{const t=e.target.closest(".btn-add-setlist");if(t){const n=t.getAttribute("data-cancion");if(n&&!l.includes(n)){l.push(n),localStorage.setItem("setlist",JSON.stringify(l)),w();const s=t.querySelector("svg");s&&(s.innerHTML='<polyline points="20 6 9 17 4 12"></polyline>',t.classList.replace("text-blue-400","text-green-400"),t.classList.replace("bg-blue-500/10","bg-green-500/10"))}}}),C&&C.addEventListener("click",()=>{const e=btoa(encodeURIComponent(JSON.stringify(l))),t=encodeURIComponent(e),s=window.location.origin+window.location.pathname+"?setlist="+t;navigator.clipboard.writeText(s).then(()=>{alert("¡Setlist copiado y abierto en una nueva pestaña!"),window.open(s,"_blank")})}),I&&I.addEventListener("click",()=>{l=[],localStorage.removeItem("setlist"),w(),window.location.href=window.location.pathname});const S=new URLSearchParams(window.location.search).get("setlist");if(S)try{const e=decodeURIComponent(atob(S)),t=JSON.parse(e);x&&(x.style.display="none"),c&&(c.style.display="none"),L&&(L.innerHTML='Setlist de la <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400">Semana</span>'),d.forEach(n=>{const s=n.getAttribute("data-cancion")||"";if(t.includes(s)){n.style.display="block";const a=n.querySelector(".btn-add-setlist");a&&(a.style.display="none")}else n.style.display="none"})}catch(e){console.error("Error validando el link del setlist:",e),window.location.href=window.location.pathname}else{let e=function(){const t=b.value.toLowerCase().trim(),n=h.value,s=y.value,a=m?m.value:"Todas";d.forEach(i=>{const B=i.getAttribute("data-titulo")||"",P=i.getAttribute("data-artista")||"",U=i.getAttribute("data-voz")||"",N=i.getAttribute("data-categoria")||"",q=i.getAttribute("data-tema")||"",z=B.includes(t)||P.includes(t),O=n==="Todas"||U.includes(n),R=s==="Todas"||N.includes(s),G=a==="Todas"||q.includes(a);z&&O&&R&&G?i.style.display="block":i.style.display="none"})};w(),b&&b.addEventListener("input",e),h&&h.addEventListener("change",e),y&&y.addEventListener("change",e),m&&m.addEventListener("change",e)}let r=null,u=null;const V=window.AudioContext||window.webkitAudioContext,o=new V;function T(){if(!o)return;o.state==="suspended"&&o.resume();const e=o.createOscillator(),t=o.createGain();e.connect(t),t.connect(o.destination),e.type="sine",e.frequency.setValueAtTime(800,o.currentTime),t.gain.setValueAtTime(1,o.currentTime),t.gain.exponentialRampToValueAtTime(.001,o.currentTime+.1),e.start(o.currentTime),e.stop(o.currentTime+.1)}document.addEventListener("click",e=>{const t=e.target.closest(".badge-bpm");if(t){const n=t.getAttribute("data-bpm");if(!n)return;const s=parseInt(n.replace(/[^0-9]/g,""),10);if(!s||s<=0)return;const a=t.querySelector(".metronomo-dot");if(!a)return;if(r&&r!==a&&(r.classList.remove("beat-active"),r.style.removeProperty("--bpm-duration"),u&&clearInterval(u)),a.classList.contains("beat-active")){a.classList.remove("beat-active"),a.style.removeProperty("--bpm-duration"),u&&clearInterval(u),r=null;return}const i=60/s;a.style.setProperty("--bpm-duration",`${i}s`),a.classList.add("beat-active"),r=a,T(),u=setInterval(T,i*1e3)}})});
