document.addEventListener("DOMContentLoaded",()=>{const y=document.getElementById("searchInput"),v=document.getElementById("filterVoz"),L=document.getElementById("filterCategoria"),u=document.getElementById("filterTema"),x=document.getElementById("mainTitle"),I=document.getElementById("searchControls"),l=document.getElementById("setlistPanel"),C=document.getElementById("setlistCount"),S=document.getElementById("btnCopySetlist"),A=document.getElementById("btnClearSetlist"),g=document.getElementById("btnViewGrid"),p=document.getElementById("btnViewList"),f=document.getElementById("gridCanciones"),d=document.querySelectorAll("#gridCanciones article");let T=!1;function B(){if(!f)return;T=!1,f.className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto",d.forEach(t=>t.classList.remove("modo-lista","expandido")),((t,e)=>{!t||!e||(t.classList.add("bg-neutral-800","text-white","shadow-sm"),t.classList.remove("text-neutral-400","hover:text-white"),e.classList.remove("bg-neutral-800","text-white","shadow-sm"),e.classList.add("text-neutral-400","hover:text-white"))})(g,p)}function O(){if(!f)return;T=!0,f.className="flex flex-col gap-3 max-w-4xl mx-auto",d.forEach(t=>t.classList.add("modo-lista")),((t,e)=>{!t||!e||(e.classList.add("bg-neutral-800","text-white","shadow-sm"),e.classList.remove("text-neutral-400","hover:text-white"),t.classList.remove("bg-neutral-800","text-white","shadow-sm"),t.classList.add("text-neutral-400","hover:text-white"))})(g,p)}g&&g.addEventListener("click",B),p&&p.addEventListener("click",O),d.forEach(n=>{const t=n.querySelector(".card-header");t&&t.addEventListener("click",e=>{e.target.closest(".btn-add-setlist")||T&&n.classList.toggle("expandido")})});let c=JSON.parse(localStorage.getItem("setlist")||"[]");function w(){C&&(C.textContent=c.length.toString()),l&&(c.length>0?l.classList.remove("hidden"):l.classList.add("hidden"))}document.addEventListener("click",n=>{const t=n.target.closest(".btn-add-setlist");if(t){const e=t.getAttribute("data-cancion");if(e&&!c.includes(e)){c.push(e),localStorage.setItem("setlist",JSON.stringify(c)),w();const s=t.querySelector("svg");s&&(s.innerHTML='<polyline points="20 6 9 17 4 12"></polyline>',t.classList.replace("text-blue-400","text-green-400"),t.classList.replace("bg-blue-500/10","bg-green-500/10"))}}}),S&&S.addEventListener("click",()=>{const n=btoa(encodeURIComponent(JSON.stringify(c))),t=encodeURIComponent(n),s=window.location.origin+window.location.pathname+"?setlist="+t;navigator.clipboard.writeText(s).then(()=>{alert("¡Setlist copiado y abierto en una nueva pestaña!"),window.open(s,"_blank")})}),A&&A.addEventListener("click",()=>{c=[],localStorage.removeItem("setlist"),w(),window.location.href=window.location.pathname});const V=new URLSearchParams(window.location.search).get("setlist");if(V)try{const n=decodeURIComponent(atob(V)),t=JSON.parse(n);I&&(I.style.display="none"),l&&(l.style.display="none"),x&&(x.innerHTML='Setlist de la <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400">Semana</span>'),d.forEach(e=>{const s=e.getAttribute("data-cancion")||"";if(t.includes(s)){e.style.display="block";const o=e.querySelector(".btn-add-setlist");o&&(o.style.display="none")}else e.style.display="none"})}catch(n){console.error("Error validando el link del setlist:",n),window.location.href=window.location.pathname}else{let n=function(){const t=y.value.toLowerCase().trim(),e=v.value,s=L.value,o=u?u.value:"Todas";d.forEach(i=>{const P=i.getAttribute("data-titulo")||"",R=i.getAttribute("data-artista")||"",q=i.getAttribute("data-voz")||"",N=i.getAttribute("data-categoria")||"",U=i.getAttribute("data-tema")||"",z=P.includes(t)||R.includes(t),D=e==="Todas"||q.includes(e),H=s==="Todas"||N.includes(s),J=o==="Todas"||U.includes(o);z&&D&&H&&J?i.style.display="block":i.style.display="none"})};w(),y&&y.addEventListener("input",n),v&&v.addEventListener("change",n),L&&L.addEventListener("change",n),u&&u.addEventListener("change",n)}const h=document.getElementById("btn-theme-toggle"),b=document.getElementById("logo-img");function E(n){if(!h)return;const t=h.querySelector("svg");n==="claro"?(document.body.classList.add("tema-claro"),b&&(b.src="/LOGO REDIL LIGHT.png"),t&&(t.innerHTML='<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>')):(document.body.classList.remove("tema-claro"),b&&(b.src="/LOGO REDIL.png"),t&&(t.innerHTML='<circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path>'))}localStorage.getItem("tema")==="claro"?E("claro"):E("oscuro"),h&&h.addEventListener("click",()=>{const t=document.body.classList.contains("tema-claro")?"oscuro":"claro";localStorage.setItem("tema",t),E(t)});let r=null,m=null;const G=window.AudioContext||window.webkitAudioContext,a=new G;function k(){if(!a)return;a.state==="suspended"&&a.resume();const n=a.createOscillator(),t=a.createGain();n.connect(t),t.connect(a.destination),n.type="sine",n.frequency.setValueAtTime(800,a.currentTime),t.gain.setValueAtTime(1,a.currentTime),t.gain.exponentialRampToValueAtTime(.001,a.currentTime+.1),n.start(a.currentTime),n.stop(a.currentTime+.1)}document.addEventListener("click",n=>{const t=n.target.closest(".badge-bpm");if(t){const e=t.getAttribute("data-bpm");if(!e)return;const s=parseInt(e.replace(/[^0-9]/g,""),10);if(!s||s<=0)return;const o=t.querySelector(".metronomo-dot");if(!o)return;if(r&&r!==o&&(r.classList.remove("beat-active"),r.style.removeProperty("--bpm-duration"),m&&clearInterval(m)),o.classList.contains("beat-active")){o.classList.remove("beat-active"),o.style.removeProperty("--bpm-duration"),m&&clearInterval(m),r=null;return}const i=60/s;o.style.setProperty("--bpm-duration",`${i}s`),o.classList.add("beat-active"),r=o,k(),m=setInterval(k,i*1e3)}});const M={C:261.63,"C#":277.18,D:293.66,Eb:311.13,E:329.63,F:349.23,"F#":369.99,G:392,"G#":415.3,A:440,Bb:466.16,B:493.88};document.addEventListener("click",n=>{const t=n.target.closest(".badge-tono");if(t){let e=t.getAttribute("data-tono");if(!e||e.trim()==="-"||e.trim()==="")return;e=e.replace(/m/g,"").trim();const s=M[e];if(s&&a){a.state==="suspended"&&a.resume();const o=a.createOscillator(),i=a.createGain();o.connect(i),i.connect(a.destination),o.type="sine",o.frequency.setValueAtTime(s,a.currentTime),i.gain.setValueAtTime(.001,a.currentTime),i.gain.exponentialRampToValueAtTime(1,a.currentTime+.1),i.gain.setValueAtTime(1,a.currentTime+1.5),i.gain.exponentialRampToValueAtTime(.001,a.currentTime+2.5),o.start(a.currentTime),o.stop(a.currentTime+2.5)}}})});
