document.addEventListener("DOMContentLoaded",()=>{const f=document.getElementById("searchInput"),p=document.getElementById("filterVoz"),b=document.getElementById("filterCategoria"),d=document.getElementById("filterTema"),v=document.getElementById("mainTitle"),w=document.getElementById("searchControls"),c=document.getElementById("setlistPanel"),L=document.getElementById("setlistCount"),E=document.getElementById("btnCopySetlist"),x=document.getElementById("btnClearSetlist"),m=document.getElementById("btnViewGrid"),u=document.getElementById("btnViewList"),g=document.getElementById("gridCanciones"),r=document.querySelectorAll("#gridCanciones article");let h=!1;function I(){if(!g)return;h=!1,g.className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto",r.forEach(t=>t.classList.remove("modo-lista","expandido")),((t,e)=>{!t||!e||(t.classList.add("bg-neutral-800","text-white","shadow-sm"),t.classList.remove("text-neutral-400","hover:text-white"),e.classList.remove("bg-neutral-800","text-white","shadow-sm"),e.classList.add("text-neutral-400","hover:text-white"))})(m,u)}function C(){if(!g)return;h=!0,g.className="flex flex-col gap-3 max-w-4xl mx-auto",r.forEach(t=>t.classList.add("modo-lista")),((t,e)=>{!t||!e||(e.classList.add("bg-neutral-800","text-white","shadow-sm"),e.classList.remove("text-neutral-400","hover:text-white"),t.classList.remove("bg-neutral-800","text-white","shadow-sm"),t.classList.add("text-neutral-400","hover:text-white"))})(m,u)}m&&m.addEventListener("click",I),u&&u.addEventListener("click",C),r.forEach(s=>{const t=s.querySelector(".card-header");t&&t.addEventListener("click",e=>{e.target.closest(".btn-add-setlist")||h&&s.classList.toggle("expandido")})});let i=JSON.parse(localStorage.getItem("setlist")||"[]");function y(){L&&(L.textContent=i.length.toString()),c&&(i.length>0?c.classList.remove("hidden"):c.classList.add("hidden"))}document.addEventListener("click",s=>{const t=s.target.closest(".btn-add-setlist");if(t){const e=t.getAttribute("data-cancion");if(e&&!i.includes(e)){i.push(e),localStorage.setItem("setlist",JSON.stringify(i)),y();const n=t.querySelector("svg");n&&(n.innerHTML='<polyline points="20 6 9 17 4 12"></polyline>',t.classList.replace("text-blue-400","text-green-400"),t.classList.replace("bg-blue-500/10","bg-green-500/10"))}}}),E&&E.addEventListener("click",()=>{const s=btoa(encodeURIComponent(JSON.stringify(i))),t=encodeURIComponent(s),n=window.location.origin+window.location.pathname+"?setlist="+t;navigator.clipboard.writeText(n).then(()=>{alert("¡Setlist copiado y abierto en una nueva pestaña!"),window.open(n,"_blank")})}),x&&x.addEventListener("click",()=>{i=[],localStorage.removeItem("setlist"),y(),window.location.href=window.location.pathname});const S=new URLSearchParams(window.location.search).get("setlist");if(S)try{const s=decodeURIComponent(atob(S)),t=JSON.parse(s);w&&(w.style.display="none"),c&&(c.style.display="none"),v&&(v.innerHTML='Setlist de la <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400">Semana</span>'),r.forEach(e=>{const n=e.getAttribute("data-cancion")||"";if(t.includes(n)){e.style.display="block";const a=e.querySelector(".btn-add-setlist");a&&(a.style.display="none")}else e.style.display="none"})}catch(s){console.error("Error validando el link del setlist:",s),window.location.href=window.location.pathname}else{let s=function(){const t=f.value.toLowerCase().trim(),e=p.value,n=b.value,a=d?d.value:"Todas";r.forEach(o=>{const T=o.getAttribute("data-titulo")||"",k=o.getAttribute("data-artista")||"",A=o.getAttribute("data-voz")||"",V=o.getAttribute("data-categoria")||"",B=o.getAttribute("data-tema")||"",P=T.includes(t)||k.includes(t),U=e==="Todas"||A.includes(e),z=n==="Todas"||V.includes(n),N=a==="Todas"||B.includes(a);P&&U&&z&&N?o.style.display="block":o.style.display="none"})};y(),f&&f.addEventListener("input",s),p&&p.addEventListener("change",s),b&&b.addEventListener("change",s),d&&d.addEventListener("change",s)}let l=null;document.addEventListener("click",s=>{const t=s.target.closest(".badge-bpm");if(t){const e=t.getAttribute("data-bpm");if(!e)return;const n=parseInt(e.replace(/[^0-9]/g,""),10);if(!n||n<=0)return;const a=t.querySelector(".metronomo-dot");if(!a)return;if(l&&l!==a&&(l.classList.remove("beat-active"),l.style.removeProperty("--bpm-duration")),a.classList.contains("beat-active")){a.classList.remove("beat-active"),a.style.removeProperty("--bpm-duration"),l=null;return}const o=60/n;a.style.setProperty("--bpm-duration",`${o}s`),a.classList.add("beat-active"),l=a}})});
