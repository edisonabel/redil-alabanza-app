document.addEventListener("DOMContentLoaded",()=>{const y=document.getElementById("searchInput"),v=document.getElementById("filterVoz"),L=document.getElementById("filterCategoria"),T=document.getElementById("filterTema"),S=document.getElementById("mainTitle"),A=document.getElementById("searchControls"),d=document.getElementById("setlistPanel"),V=document.getElementById("setlistCount"),k=document.getElementById("btnCopySetlist"),B=document.getElementById("btnClearSetlist"),g=document.getElementById("btnViewGrid"),p=document.getElementById("btnViewList"),f=document.getElementById("gridCanciones"),m=document.querySelectorAll("#gridCanciones article");let w=!1;function G(){if(!f)return;w=!1,f.className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto",m.forEach(e=>e.classList.remove("modo-lista","expandido")),((e,t)=>{!e||!t||(e.classList.add("bg-neutral-800","text-white","shadow-sm"),e.classList.remove("text-neutral-400","hover:text-white"),t.classList.remove("bg-neutral-800","text-white","shadow-sm"),t.classList.add("text-neutral-400","hover:text-white"))})(g,p)}function P(){if(!f)return;w=!0,f.className="flex flex-col gap-3 max-w-4xl mx-auto",m.forEach(e=>e.classList.add("modo-lista")),((e,t)=>{!e||!t||(t.classList.add("bg-neutral-800","text-white","shadow-sm"),t.classList.remove("text-neutral-400","hover:text-white"),e.classList.remove("bg-neutral-800","text-white","shadow-sm"),e.classList.add("text-neutral-400","hover:text-white"))})(g,p)}g&&g.addEventListener("click",G),p&&p.addEventListener("click",P),m.forEach(n=>{const e=n.querySelector(".card-header");e&&e.addEventListener("click",t=>{t.target.closest(".btn-add-setlist")||w&&n.classList.toggle("expandido")})});let r=JSON.parse(localStorage.getItem("setlist")||"[]");function E(){V&&(V.textContent=r.length.toString()),d&&(r.length>0?d.classList.remove("hidden"):d.classList.add("hidden"))}document.addEventListener("click",n=>{const e=n.target.closest(".btn-add-setlist");if(e){const t=e.getAttribute("data-cancion");if(t&&!r.includes(t)){r.push(t),localStorage.setItem("setlist",JSON.stringify(r)),E();const s=e.querySelector("svg");s&&(s.innerHTML='<polyline points="20 6 9 17 4 12"></polyline>',e.classList.replace("text-blue-400","text-green-400"),e.classList.replace("bg-blue-500/10","bg-green-500/10"))}}}),k&&k.addEventListener("click",()=>{const n=btoa(encodeURIComponent(JSON.stringify(r))),e=encodeURIComponent(n),s=window.location.origin+window.location.pathname+"?setlist="+e;navigator.clipboard.writeText(s).then(()=>{alert("¡Setlist copiado y abierto en una nueva pestaña!"),window.open(s,"_blank")})}),B&&B.addEventListener("click",()=>{r=[],localStorage.removeItem("setlist"),E(),window.location.href=window.location.pathname});const M=new URLSearchParams(window.location.search).get("setlist");if(M)try{const n=decodeURIComponent(atob(M)),e=JSON.parse(n);A&&(A.style.display="none"),d&&(d.style.display="none"),S&&(S.innerHTML='Setlist de la <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400">Semana</span>'),m.forEach(t=>{const s=t.getAttribute("data-cancion")||"";if(e.includes(s)){t.style.display="block";const a=t.querySelector(".btn-add-setlist");a&&(a.style.display="none")}else t.style.display="none"})}catch(n){console.error("Error validando el link del setlist:",n),window.location.href=window.location.pathname}else{let n=function(){const a=document.querySelectorAll(".cancion-oculta");if(a.length===0){t&&(t.style.display="none");return}Array.from(a).slice(0,15).forEach(i=>i.classList.remove("cancion-oculta"))},e=function(){const a=y.value.toLowerCase().trim(),i=v.value,x=L.value,C=T.value;m.forEach(c=>{const N=c.getAttribute("data-titulo")||"",U=c.getAttribute("data-artista")||"",z=c.getAttribute("data-voz")||"",D=c.getAttribute("data-categoria")||"",H=c.getAttribute("data-tema")||"",J=N.includes(a)||U.includes(a),F=i==="Todas"||z.includes(i),_=x==="Todas"||D.includes(x),$=C==="Todas"||H.includes(C);J&&F&&_&&$?(c.style.display="block",(a!==""||i!=="Todas"||x!=="Todas"||C!=="Todas")&&c.classList.remove("cancion-oculta")):c.style.display="none"})};E();const t=document.getElementById("scroll-sentinel"),s=new IntersectionObserver(a=>{a[0].isIntersecting&&n()},{rootMargin:"200px"});t&&s.observe(t),y&&y.addEventListener("input",e),v&&v.addEventListener("change",e),L&&L.addEventListener("change",e),T&&T.addEventListener("change",e)}const h=document.getElementById("btn-theme-toggle"),b=document.getElementById("logo-img");function I(n){if(!h)return;const e=h.querySelector("svg");n==="claro"?(document.body.classList.add("tema-claro"),b&&(b.src="/LOGO REDIL LIGHT.png"),e&&(e.innerHTML='<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>')):(document.body.classList.remove("tema-claro"),b&&(b.src="/LOGO REDIL.png"),e&&(e.innerHTML='<circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path>'))}localStorage.getItem("tema")==="claro"?I("claro"):I("oscuro"),h&&h.addEventListener("click",()=>{const e=document.body.classList.contains("tema-claro")?"oscuro":"claro";localStorage.setItem("tema",e),I(e)});let l=null,u=null;const q=window.AudioContext||window.webkitAudioContext,o=new q;function O(){if(!o)return;o.state==="suspended"&&o.resume();const n=o.createOscillator(),e=o.createGain();n.connect(e),e.connect(o.destination),n.type="sine",n.frequency.setValueAtTime(800,o.currentTime),e.gain.setValueAtTime(1,o.currentTime),e.gain.exponentialRampToValueAtTime(.001,o.currentTime+.1),n.start(o.currentTime),n.stop(o.currentTime+.1)}document.addEventListener("click",n=>{const e=n.target.closest(".badge-bpm");if(e){const t=e.getAttribute("data-bpm");if(!t)return;const s=parseInt(t.replace(/[^0-9]/g,""),10);if(!s||s<=0)return;const a=e.querySelector(".metronomo-dot");if(!a)return;if(l&&l!==a&&(l.classList.remove("beat-active"),l.style.removeProperty("--bpm-duration"),u&&clearInterval(u)),a.classList.contains("beat-active")){a.classList.remove("beat-active"),a.style.removeProperty("--bpm-duration"),u&&clearInterval(u),l=null;return}const i=60/s;a.style.setProperty("--bpm-duration",`${i}s`),a.classList.add("beat-active"),l=a,O(),u=setInterval(O,i*1e3)}});const R={C:261.63,"C#":277.18,D:293.66,Eb:311.13,E:329.63,F:349.23,"F#":369.99,G:392,"G#":415.3,A:440,Bb:466.16,B:493.88};document.addEventListener("click",n=>{const e=n.target.closest(".badge-tono");if(e){let t=e.getAttribute("data-tono");if(!t||t.trim()==="-"||t.trim()==="")return;t=t.replace(/m/g,"").trim();const s=R[t];if(s&&o){o.state==="suspended"&&o.resume();const a=o.createOscillator(),i=o.createGain();a.connect(i),i.connect(o.destination),a.type="sine",a.frequency.setValueAtTime(s,o.currentTime),i.gain.setValueAtTime(.001,o.currentTime),i.gain.exponentialRampToValueAtTime(1,o.currentTime+.1),i.gain.setValueAtTime(1,o.currentTime+1.5),i.gain.exponentialRampToValueAtTime(.001,o.currentTime+2.5),a.start(o.currentTime),a.stop(o.currentTime+2.5)}}})});
